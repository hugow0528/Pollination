<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pollination Hub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Markdown & Highlight -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #3b82f6;
            --bg-dark: #020617;
            --bg-card: #111827;
        }

        /* Dynamic Viewport Height for Mobile */
        body {
            height: 100dvh; /* Critical fix for mobile browsers */
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Sidebar Tabs */
        .sidebar-tab.active { color: white; border-bottom: 2px solid #3b82f6; }
        .sidebar-tab { color: #9ca3af; border-bottom: 2px solid transparent; }

        /* Modal Overlay */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }

        /* Markdown & Math Enhancements */
        .prose table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .prose th, .prose td { border: 1px solid #374151; padding: 0.5rem; text-align: left; }
        .prose th { background-color: #1f2937; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        
        /* Thinking Block */
        .think-block {
            background: #1f293750;
            border-left: 3px solid #6b7280;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 0.9em;
            color: #9ca3af;
        }
        .think-block summary { cursor: pointer; font-weight: bold; opacity: 0.8; user-select: none; }
        .think-block summary:hover { opacity: 1; color: #e5e7eb; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        darker: '#020617',
                        card: '#1e293b'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-darker text-gray-100 flex overflow-hidden font-sans selection:bg-primary/30">

    <!-- Settings Modal -->
    <div id="keyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300 px-4">
        <div class="bg-card border border-gray-700 p-6 rounded-2xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 flex flex-col max-h-[90dvh]" id="keyModalContent">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-sliders-h text-primary mr-2"></i>Configuration</h3>
                <button onclick="toggleKeyModal(false)" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="overflow-y-auto pr-2 space-y-5 custom-scrollbar flex-1">
                <!-- API Keys -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wider">Pollinations API Keys</label>
                    <p class="text-xs text-gray-400 mb-2">
                        Enter multiple keys (one per line) to distribute load.
                        <a href="https://enter.pollinations.ai/" target="_blank" class="text-primary hover:underline">Get a key here</a>.
                    </p>
                    <textarea id="apiKeyInput" rows="3" placeholder="pk_key1&#10;pk_key2&#10;pk_key3" class="w-full bg-darker border border-gray-700 rounded-lg px-4 py-3 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-white transition-all font-mono"></textarea>
                </div>

                <!-- System Prompt -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wider">System Prompt</label>
                    <p class="text-xs text-gray-400 mb-2">Define how the AI should behave.</p>
                    <textarea id="systemPromptInput" rows="3" placeholder="You are a helpful AI assistant." class="w-full bg-darker border border-gray-700 rounded-lg px-4 py-3 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-white transition-all"></textarea>
                </div>
            </div>

            <div class="mt-6 flex-shrink-0 space-y-3">
                <button onclick="saveSettings()" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-2.5 rounded-lg transition-colors shadow-lg shadow-blue-900/20">
                    Save Configuration
                </button>
                <button onclick="clearSettings()" class="w-full bg-transparent border border-gray-700 text-gray-400 hover:text-white hover:border-red-500 hover:bg-red-900/20 text-xs py-2 rounded-lg transition-all">
                    Reset to Defaults
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-gray-900/95 backdrop-blur-xl border-r border-gray-800 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl h-full">
        
        <!-- Brand -->
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/50">
                    <i class="fas fa-magic text-white text-xs"></i>
                </div>
                <h1 class="text-lg font-bold tracking-tight text-gray-100">Pollination Hub</h1>
            </div>
            <button id="closeSidebar" class="md:hidden text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Sidebar Tabs -->
        <div class="flex text-sm font-medium text-center bg-gray-900/50 border-b border-gray-800 flex-shrink-0">
            <button onclick="switchSidebarTab('history')" id="tabHistory" class="sidebar-tab active flex-1 py-3 hover:text-white transition-colors">
                <i class="fas fa-history mr-2"></i>History
            </button>
            <button onclick="switchSidebarTab('models')" id="tabModels" class="sidebar-tab flex-1 py-3 hover:text-white transition-colors">
                <i class="fas fa-layer-group mr-2"></i>Models
            </button>
        </div>

        <!-- Mode Switcher -->
        <div class="p-3 bg-gray-900/30 flex-shrink-0">
            <div class="flex bg-black/40 p-1 rounded-xl border border-gray-800">
                <button onclick="switchMode('text')" id="modeText" class="flex-1 py-2 rounded-lg text-xs font-medium transition-all bg-primary text-white shadow-lg">
                    <i class="fas fa-comment-alt mr-2"></i>Chat
                </button>
                <button onclick="switchMode('image')" id="modeImage" class="flex-1 py-2 rounded-lg text-xs font-medium text-gray-400 hover:text-white transition-all">
                    <i class="fas fa-image mr-2"></i>Image
                </button>
            </div>
        </div>

        <!-- TAB CONTENT: HISTORY -->
        <div id="viewHistory" class="flex-1 flex flex-col overflow-hidden min-h-0">
            <div class="px-3 pt-2 flex-shrink-0">
                <button onclick="startNewChat()" class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white rounded-lg px-4 py-2.5 text-sm flex items-center gap-2 transition-all mb-2 group">
                    <i class="fas fa-plus text-primary group-hover:text-white transition-colors"></i>
                    <span>New Conversation</span>
                </button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto px-2 space-y-1 pb-2">
                <!-- History Items -->
            </div>
        </div>

        <!-- TAB CONTENT: MODELS -->
        <div id="viewModels" class="hidden flex-1 flex flex-col overflow-hidden min-h-0">
            <div class="px-3 pt-2 pb-2 flex-shrink-0">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-500"></i>
                    <input type="text" id="modelSearch" placeholder="Filter models..." class="w-full bg-black/20 border border-gray-700 rounded-lg py-2 pl-9 pr-3 text-sm focus:outline-none focus:border-primary placeholder-gray-600">
                </div>
            </div>
            <div id="modelListContainer" class="flex-1 overflow-y-auto px-2 space-y-1 pb-4">
                <div class="flex justify-center p-8">
                    <i class="fas fa-circle-notch fa-spin text-primary"></i>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-3 border-t border-gray-800 bg-black/20 text-xs flex-shrink-0 pb-[env(safe-area-inset-bottom)]">
            <button onclick="toggleKeyModal(true)" class="w-full flex items-center justify-between p-2 rounded hover:bg-gray-800 transition-colors mb-2 group">
                <span class="text-gray-400 group-hover:text-white"><i class="fas fa-cog mr-2"></i>Settings</span>
                <div class="flex items-center gap-2">
                     <span id="keyCountBadge" class="hidden bg-primary/20 text-primary px-1.5 rounded text-[10px]">0 Keys</span>
                    <i class="fas fa-chevron-right text-gray-600 text-[10px]"></i>
                </div>
            </button>

            <div class="flex items-center gap-2 mb-3 px-2" id="systemStatusContainer">
                <div id="statusDot" class="w-2 h-2 bg-gray-500 rounded-full"></div>
                <span id="statusText" class="text-gray-400 font-mono">CHECKING...</span>
            </div>
            
            <div class="border-t border-gray-800 pt-3 text-center">
                <p class="text-gray-500 font-medium">Copyright Â© 2025 Wong.</p>
                <p class="text-gray-600 text-[10px]">All rights reserved.</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative w-full bg-gradient-to-b from-darker to-[#050a14] min-w-0">
        <!-- Header -->
        <header class="h-16 border-b border-gray-800/50 bg-gray-900/50 backdrop-blur-md flex items-center justify-between px-4 sticky top-0 z-20 flex-shrink-0">
            <div class="flex items-center gap-3">
                <button id="toggleSidebar" class="md:hidden text-gray-400 hover:text-white p-2">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="flex flex-col overflow-hidden">
                    <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="switchSidebarTab('models'); if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('-translate-x-full');">
                        <span id="currentModeIcon" class="text-primary flex-shrink-0"><i class="fas fa-robot"></i></span>
                        <span id="currentModelDisplay" class="font-bold text-gray-100 tracking-wide truncate">Gemini</span>
                        <i class="fas fa-chevron-down text-xs text-gray-500 flex-shrink-0"></i>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="clearAllHistory()" class="hidden sm:block text-gray-500 hover:text-red-400 text-xs transition-colors p-2" title="Clear History">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth overscroll-contain">
            <div id="welcomeState" class="h-full flex flex-col items-center justify-center text-center p-6 opacity-60">
                <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-3xl flex items-center justify-center text-4xl shadow-2xl shadow-blue-900/50 mb-6">
                    <i class="fas fa-magic text-white"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Create & Chat</h2>
                <p class="text-gray-400 max-w-md">Configure your keys in settings. Supports Math (LaTeX) and advanced rendering.</p>
                <button onclick="toggleKeyModal(true)" class="mt-4 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-sm rounded-lg text-white transition-colors border border-gray-700">
                    <i class="fas fa-cog mr-2"></i>Configure
                </button>
            </div>
        </div>

        <!-- Input Area (Sticky Bottom for Mobile Stability) -->
        <div class="border-t border-gray-800 bg-gray-900/80 backdrop-blur-lg flex-shrink-0 sticky bottom-0 z-30 pb-[env(safe-area-inset-bottom)]">
            <div class="p-4 max-w-4xl mx-auto space-y-3">
                
                <!-- Image Controls -->
                <div id="imageControls" class="hidden flex flex-wrap gap-2 animate-fade-in">
                    <select id="aspectRatio" class="bg-gray-800 text-xs text-white border border-gray-700 rounded px-2 py-1 focus:border-primary outline-none">
                        <option value="1:1">Square (1:1)</option>
                        <option value="16:9">Landscape (16:9)</option>
                        <option value="9:16">Portrait (9:16)</option>
                    </select>
                    <label class="flex items-center gap-2 cursor-pointer bg-gray-800 border border-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-700 transition-colors">
                        <input type="checkbox" id="enhancePrompt" class="accent-primary">
                        <span class="text-gray-300">Magic Enhance</span>
                    </label>
                </div>

                <form id="chatForm" class="relative flex items-end gap-2 bg-gray-800/50 rounded-xl border border-gray-700 p-2 focus-within:border-primary focus-within:ring-1 focus-within:ring-primary/50 transition-all shadow-xl">
                    <textarea 
                        id="userInput" 
                        rows="1" 
                        placeholder="Type your message..." 
                        class="w-full bg-transparent text-white placeholder-gray-500 resize-none border-none focus:ring-0 py-3 px-3 max-h-40 min-h-[44px]"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    
                    <button type="submit" id="sendBtn" class="bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary text-white rounded-lg w-10 h-10 flex items-center justify-center transition-all active:scale-95 shadow-lg shadow-blue-500/20 flex-shrink-0">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const API_ENDPOINTS = {
            textModels: "https://gen.pollinations.ai/v1/models",
            textChat: "https://gen.pollinations.ai/v1/chat/completions",
            imageModels: "https://gen.pollinations.ai/image/models",
            imageGen: "https://gen.pollinations.ai/image/" 
        };

        const DEFAULT_SYSTEM_PROMPT = "You are a helpful AI assistant. Answer efficiently and accurately.";

        // State
        let state = {
            mode: 'text',
            textModel: 'gemini',
            imageModel: 'flux',
            currentChatId: null,
            models: { text: [], image: [] },
            apiKeys: []
        };

        // --- DOM ELEMENTS ---
        const els = {
            sidebar: document.getElementById('sidebar'),
            chatContainer: document.getElementById('chatContainer'),
            userInput: document.getElementById('userInput'),
            modelList: document.getElementById('modelListContainer'),
            historyList: document.getElementById('historyList'),
            modelSearch: document.getElementById('modelSearch'),
            currentModelDisplay: document.getElementById('currentModelDisplay'),
            welcomeState: document.getElementById('welcomeState'),
            imageControls: document.getElementById('imageControls'),
            modeText: document.getElementById('modeText'),
            modeImage: document.getElementById('modeImage'),
            currentModeIcon: document.getElementById('currentModeIcon'),
            tabHistory: document.getElementById('tabHistory'),
            tabModels: document.getElementById('tabModels'),
            viewHistory: document.getElementById('viewHistory'),
            viewModels: document.getElementById('viewModels'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            keyModal: document.getElementById('keyModal'),
            keyModalContent: document.getElementById('keyModalContent'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            systemPromptInput: document.getElementById('systemPromptInput'),
            keyCountBadge: document.getElementById('keyCountBadge')
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initData();
            checkSystemStatus();
            loadHistoryList();
            loadSettings();
            
            // Sidebar Toggles
            document.getElementById('toggleSidebar').onclick = () => els.sidebar.classList.remove('-translate-x-full');
            document.getElementById('closeSidebar').onclick = () => els.sidebar.classList.add('-translate-x-full');
            
            // Form Submit
            document.getElementById('chatForm').onsubmit = (e) => {
                e.preventDefault();
                processMessage();
            };

            // Search
            els.modelSearch.oninput = (e) => renderModelList(e.target.value);
            
            // Polling System Status every 60s
            setInterval(checkSystemStatus, 60000);
        });

        // --- SETTINGS MANAGEMENT ---
        function loadSettings() {
            // Keys
            const savedKeys = localStorage.getItem('pollinations_api_keys');
            if (savedKeys) {
                state.apiKeys = JSON.parse(savedKeys);
                els.apiKeyInput.value = state.apiKeys.join('\n');
            }
            updateKeyBadge();

            // System Prompt
            const savedPrompt = localStorage.getItem('pollinations_system_prompt');
            els.systemPromptInput.value = savedPrompt || DEFAULT_SYSTEM_PROMPT;
        }

        function saveSettings() {
            // Parse keys
            const rawKeys = els.apiKeyInput.value.trim();
            const keyArray = rawKeys.split(/[\n,]+/).map(k => k.trim()).filter(k => k.length > 0);
            
            state.apiKeys = keyArray;
            localStorage.setItem('pollinations_api_keys', JSON.stringify(keyArray));

            // Save Prompt
            let prompt = els.systemPromptInput.value.trim();
            if(!prompt) prompt = DEFAULT_SYSTEM_PROMPT;
            localStorage.setItem('pollinations_system_prompt', prompt);

            toggleKeyModal(false);
            updateKeyBadge();
            alert('Configuration Saved!');
        }

        function clearSettings() {
            if(confirm('Reset all settings to default?')) {
                localStorage.removeItem('pollinations_api_keys');
                localStorage.removeItem('pollinations_system_prompt');
                state.apiKeys = [];
                els.apiKeyInput.value = '';
                els.systemPromptInput.value = DEFAULT_SYSTEM_PROMPT;
                updateKeyBadge();
            }
        }

        function getRotatedKey() {
            if (state.apiKeys.length === 0) return '';
            // Simple random load balance
            return state.apiKeys[Math.floor(Math.random() * state.apiKeys.length)];
        }

        function getSystemPrompt() {
            return localStorage.getItem('pollinations_system_prompt') || DEFAULT_SYSTEM_PROMPT;
        }

        function updateKeyBadge() {
            const count = state.apiKeys.length;
            if (count > 0) {
                els.keyCountBadge.textContent = `${count} Key${count > 1 ? 's' : ''}`;
                els.keyCountBadge.classList.remove('hidden');
            } else {
                els.keyCountBadge.classList.add('hidden');
            }
        }

        function toggleKeyModal(show) {
            if (show) {
                els.keyModal.classList.remove('hidden');
                setTimeout(() => {
                    els.keyModal.classList.remove('opacity-0');
                    els.keyModalContent.classList.remove('scale-95');
                }, 10);
                loadSettings(); // refresh display
            } else {
                els.keyModal.classList.add('opacity-0');
                els.keyModalContent.classList.add('scale-95');
                setTimeout(() => els.keyModal.classList.add('hidden'), 300);
            }
        }

        // --- DATA INIT ---
        async function initData() {
            try {
                const textRes = await fetch(API_ENDPOINTS.textModels);
                const textData = await textRes.json();
                state.models.text = textData.data || [];

                const imgRes = await fetch(API_ENDPOINTS.imageModels);
                const imgData = await imgRes.json();
                state.models.image = imgData.map(m => ({ id: m.name || m, ...m }));

                renderModelList();
                updateUI();
            } catch (e) {
                console.error("Init Error:", e);
                els.modelList.innerHTML = `<div class="text-red-400 text-xs text-center p-4">Connection Failed</div>`;
            }
        }

        // --- SYSTEM STATUS ---
        async function checkSystemStatus() {
            els.statusText.textContent = "CHECKING...";
            els.statusDot.className = "w-2 h-2 bg-yellow-500 rounded-full animate-pulse";
            try {
                const res = await fetch(API_ENDPOINTS.textModels, { method: 'HEAD' });
                if (res.ok) {
                    els.statusDot.className = "w-2 h-2 bg-green-500 rounded-full shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                    els.statusText.textContent = "SYSTEM ONLINE";
                    els.statusText.className = "text-green-400 font-bold text-[10px] tracking-wider";
                } else {
                    throw new Error("Status " + res.status);
                }
            } catch (e) {
                els.statusDot.className = "w-2 h-2 bg-red-500 rounded-full";
                els.statusText.textContent = "OFFLINE";
                els.statusText.className = "text-red-400 font-bold text-[10px]";
            }
        }

        // --- HISTORY MANAGEMENT ---
        function getHistory() { return JSON.parse(localStorage.getItem('pollination_chats') || '[]'); }
        function saveHistory(chats) { localStorage.setItem('pollination_chats', JSON.stringify(chats)); loadHistoryList(); }

        function startNewChat() {
            state.currentChatId = null;
            els.chatContainer.innerHTML = '';
            els.chatContainer.appendChild(els.welcomeState);
            els.welcomeState.style.display = 'flex';
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('bg-gray-800', 'border-gray-700'));
            if(window.innerWidth < 768) els.sidebar.classList.add('-translate-x-full');
        }

        function loadChat(chatId) {
            const chats = getHistory();
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            state.currentChatId = chatId;
            els.chatContainer.innerHTML = '';
            els.welcomeState.style.display = 'none';

            chat.messages.forEach(msg => {
                if(msg.role === 'user') appendUserMessage(msg.content, false);
                else if(msg.role === 'assistant') appendBotMessage(msg.content, false);
                else if(msg.role === 'image') appendImageResult(msg.content, msg.meta, false);
            });

            loadHistoryList();
            if(window.innerWidth < 768) els.sidebar.classList.add('-translate-x-full');
            scrollToBottom();
        }

        function saveMessageToHistory(role, content, meta = {}) {
            let chats = getHistory();
            if (!state.currentChatId) {
                state.currentChatId = Date.now();
                const title = content.length > 30 ? content.substring(0, 30) + '...' : content;
                chats.unshift({
                    id: state.currentChatId,
                    title: role === 'user' ? title : 'New Chat',
                    timestamp: Date.now(),
                    messages: []
                }); 
            } else {
                const index = chats.findIndex(c => c.id === state.currentChatId);
                if (index > -1) {
                    const chat = chats.splice(index, 1)[0];
                    chat.timestamp = Date.now();
                    chats.unshift(chat);
                }
            }
            if (chats.length > 0) chats[0].messages.push({ role, content, meta });
            saveHistory(chats);
        }

        function loadHistoryList() {
            const chats = getHistory();
            els.historyList.innerHTML = '';
            if (chats.length === 0) {
                els.historyList.innerHTML = `<div class="text-center p-4 text-gray-500 text-xs">No history yet.</div>`;
                return;
            }
            chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `history-item w-full text-left px-3 py-3 rounded-lg text-sm mb-1 cursor-pointer flex items-center justify-between group transition-all ${isActive ? 'bg-gray-800 text-white border border-gray-700' : 'text-gray-400 hover:bg-gray-800/50 hover:text-gray-200 border border-transparent'}`;
                div.onclick = (e) => { if(!e.target.closest('.delete-btn')) loadChat(chat.id); };
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fas fa-message text-xs ${isActive ? 'text-primary' : 'text-gray-600'}"></i>
                        <span class="truncate">${chat.title || 'Conversation'}</span>
                    </div>
                    <button class="delete-btn opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400 transition-opacity px-2" onclick="deleteChat(event, ${chat.id})"><i class="fas fa-times"></i></button>
                `;
                els.historyList.appendChild(div);
            });
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if(!confirm('Delete this conversation?')) return;
            let chats = getHistory();
            chats = chats.filter(c => c.id !== id);
            localStorage.setItem('pollination_chats', JSON.stringify(chats));
            if (state.currentChatId === id) startNewChat();
            loadHistoryList();
        }

        function clearAllHistory() {
            if(!confirm('Delete ALL history?')) return;
            localStorage.removeItem('pollination_chats');
            startNewChat();
            loadHistoryList();
        }

        // --- SIDEBAR & MODE ---
        function switchSidebarTab(tab) {
            if (tab === 'history') {
                els.viewHistory.classList.remove('hidden');
                els.viewModels.classList.add('hidden');
                els.tabHistory.classList.add('active');
                els.tabModels.classList.remove('active');
            } else {
                els.viewHistory.classList.add('hidden');
                els.viewModels.classList.remove('hidden');
                els.tabHistory.classList.remove('active');
                els.tabModels.classList.add('active');
            }
        }

        function switchMode(mode) {
            state.mode = mode;
            if (mode === 'text') {
                els.modeText.className = "flex-1 py-2 rounded-lg text-xs font-medium transition-all bg-primary text-white shadow-lg";
                els.modeImage.className = "flex-1 py-2 rounded-lg text-xs font-medium text-gray-400 hover:text-white transition-all";
                els.imageControls.classList.add('hidden');
                els.currentModeIcon.innerHTML = '<i class="fas fa-comment-alt"></i>';
                els.userInput.placeholder = "Ask me anything...";
            } else {
                els.modeImage.className = "flex-1 py-2 rounded-lg text-xs font-medium transition-all bg-primary text-white shadow-lg";
                els.modeText.className = "flex-1 py-2 rounded-lg text-xs font-medium text-gray-400 hover:text-white transition-all";
                els.imageControls.classList.remove('hidden');
                els.currentModeIcon.innerHTML = '<i class="fas fa-paint-brush"></i>';
                els.userInput.placeholder = "Describe an image...";
            }
            updateUI();
        }

        function renderModelList(filter = "") {
            const list = state.mode === 'text' ? state.models.text : state.models.image;
            const current = state.mode === 'text' ? state.textModel : state.imageModel;
            const filtered = list.filter(m => (m.id || m).toLowerCase().includes(filter.toLowerCase()));
            els.modelList.innerHTML = filtered.map(m => {
                const id = m.id || m;
                const isSelected = id === current;
                return `
                    <button onclick="selectModel('${id}')" class="w-full text-left px-3 py-2.5 rounded-lg text-sm mb-1 transition-all flex items-center justify-between group ${isSelected ? 'bg-primary/20 text-primary border border-primary/30' : 'text-gray-400 hover:bg-gray-800 hover:text-white border border-transparent'}">
                        <span class="truncate font-medium">${id}</span>
                        ${isSelected ? '<i class="fas fa-check text-xs"></i>' : ''}
                    </button>
                `;
            }).join('');
        }

        function selectModel(id) {
            if (state.mode === 'text') state.textModel = id;
            else state.imageModel = id;
            updateUI();
            renderModelList(els.modelSearch.value);
        }

        function updateUI() {
            els.currentModelDisplay.textContent = state.mode === 'text' ? state.textModel : state.imageModel;
            renderModelList(els.modelSearch.value);
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); processMessage(); }
        }

        // --- MESSAGING LOGIC ---
        async function processMessage() {
            const text = els.userInput.value.trim();
            if (!text) return;

            els.welcomeState.style.display = 'none';
            els.userInput.value = '';
            els.userInput.style.height = 'auto';

            appendUserMessage(text);
            saveMessageToHistory('user', text);

            if (state.mode === 'text') await handleTextGeneration(text);
            else handleImageGeneration(text);
        }

        async function handleTextGeneration(prompt) {
            const loadingId = appendLoading('text');
            const apiKey = getRotatedKey();

            let contextMessages = [];
            if (state.currentChatId) {
                const chat = getHistory().find(c => c.id === state.currentChatId);
                if (chat) {
                    const history = chat.messages.slice(0, -1).slice(-8).map(m => ({
                        role: m.role === 'image' ? 'assistant' : m.role,
                        content: m.content
                    }));
                    contextMessages = history;
                }
            }

            // System prompt injection
            const messages = [
                { role: "system", content: getSystemPrompt() },
                ...contextMessages,
                { role: "user", content: prompt }
            ];

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;

                const response = await fetch(API_ENDPOINTS.textChat, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: state.textModel,
                        messages: messages
                    })
                });

                if (!response.ok) throw new Error(`API ${response.status}`);
                const data = await response.json();
                const reply = data.choices[0].message.content;

                removeElement(loadingId);
                appendBotMessage(reply);
                saveMessageToHistory('assistant', reply);

            } catch (err) {
                removeElement(loadingId);
                appendErrorMessage(err.message);
            }
        }

        function handleImageGeneration(prompt) {
            const loadingId = appendLoading('image');
            const apiKey = getRotatedKey();
            
            const ratio = document.getElementById('aspectRatio').value;
            const enhance = document.getElementById('enhancePrompt').checked;
            const seed = Math.floor(Math.random() * 1000000);
            
            let w = 1024, h = 1024;
            if (ratio === '16:9') { w = 1280; h = 720; }
            if (ratio === '9:16') { w = 720; h = 1280; }

            const encodedPrompt = encodeURIComponent(prompt);
            let url = `${API_ENDPOINTS.imageGen}${encodedPrompt}?model=${state.imageModel}&width=${w}&height=${h}&seed=${seed}&enhance=${enhance}&nologo=true`;
            if(apiKey) url += `&key=${apiKey}`;

            removeElement(loadingId);
            const meta = { model: state.imageModel, seed: seed, width: w, height: h };
            appendImageResult(url, meta);
            saveMessageToHistory('image', url, meta);
        }

        // --- DOM RENDERERS ---

        function appendUserMessage(text, scroll=true) {
            const div = document.createElement('div');
            div.className = "flex justify-end animate-fade-in mb-6";
            div.innerHTML = `
                <div class="max-w-[85%] flex flex-row-reverse gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-user text-xs text-white"></i>
                    </div>
                    <div class="bg-primary text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-lg text-sm leading-relaxed whitespace-pre-wrap">${text}</div>
                </div>
            `;
            els.chatContainer.appendChild(div);
            if(scroll) scrollToBottom();
        }

        function appendBotMessage(text, scroll=true) {
            const div = document.createElement('div');
            div.className = "flex justify-start animate-fade-in mb-6";
            
            // 1. Process Thinking Tags: <think>...</think>
            let processedText = text.replace(
                /<think>([\s\S]*?)<\/think>/gi, 
                "<details class='think-block'><summary>Thinking Process</summary>$1</details>"
            );

            // 2. Render Markdown
            let htmlContent = marked.parse(processedText);

            div.innerHTML = `
                <div class="max-w-[85%] md:max-w-[75%] flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-emerald-700 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-robot text-xs text-white"></i>
                    </div>
                    <div class="bg-card text-gray-200 px-5 py-4 rounded-2xl rounded-tl-none border border-gray-700 shadow-sm prose prose-invert prose-sm max-w-none w-full overflow-hidden">
                        ${htmlContent}
                    </div>
                </div>
            `;
            els.chatContainer.appendChild(div);

            // 3. Highlight Code
            div.querySelectorAll('pre code').forEach(hljs.highlightElement);

            // 4. Render Math (KaTeX)
            renderMathInElement(div, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

            if(scroll) scrollToBottom();
        }

        function appendImageResult(url, meta, scroll=true) {
            const div = document.createElement('div');
            div.className = "flex justify-start animate-fade-in mb-6";
            const skelId = 'skel-' + Math.random().toString(36).substr(2, 9);
            div.innerHTML = `
                <div class="flex gap-3 max-w-full">
                    <div class="w-8 h-8 rounded-full bg-purple-600 flex-shrink-0 flex items-center justify-center mt-1">
                        <i class="fas fa-paint-brush text-xs text-white"></i>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div class="relative rounded-xl overflow-hidden border border-gray-700 bg-gray-900 group min-w-[200px] min-h-[200px]">
                            <div class="image-skeleton absolute inset-0 z-10 pointer-events-none" id="${skelId}"></div>
                            <img src="${url}" alt="Generated Image" class="max-w-full md:max-w-md rounded-xl block"
                                onload="document.getElementById('${skelId}').remove()"
                                onerror="this.src=''; this.alt='Failed to load'; document.getElementById('${skelId}').remove();">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3">
                                <a href="${url}" target="_blank" download="image.jpg" class="bg-white text-black px-3 py-1.5 rounded-full text-xs font-bold hover:scale-105 transition-transform">
                                    <i class="fas fa-download mr-1"></i> Download
                                </a>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 font-mono">${meta.model} | ${meta.width}x${meta.height}</div>
                    </div>
                </div>
            `;
            els.chatContainer.appendChild(div);
            if(scroll) scrollToBottom();
        }

        function appendLoading(type) {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex justify-start mb-6";
            div.innerHTML = `
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full ${type === 'text' ? 'bg-green-600' : 'bg-purple-600'} flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin text-xs text-white"></i>
                    </div>
                    <div class="bg-card border border-gray-700 px-4 py-3 rounded-2xl rounded-tl-none flex items-center gap-1">
                        <span class="text-xs text-gray-400 mr-2">${type === 'text' ? 'Thinking' : 'Painting'}</span>
                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            els.chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function appendErrorMessage(msg) {
            const div = document.createElement('div');
            div.className = "flex justify-center mb-6";
            div.innerHTML = `
                <div class="bg-red-900/20 border border-red-800 text-red-300 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                    <i class="fas fa-exclamation-circle"></i>${msg}
                </div>
            `;
            els.chatContainer.appendChild(div);
            scrollToBottom();
        }

        function removeElement(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { els.chatContainer.scrollTop = els.chatContainer.scrollHeight; }
    </script>
</body>
</html>
